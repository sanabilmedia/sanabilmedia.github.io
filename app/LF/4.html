<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل الطلاقة</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            background-color: #f0f0f0;
        }
        select, button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
        }
        #status {
            margin-top: 20px;
            font-size: 18px;
        }
        #timer {
            font-size: 24px;
            font-weight: bold;
            margin: 10px;
        }
        #waveform {
            width: 300px;
            height: 100px;
            border: 1px solid #ccc;
            margin: 20px;
            position: relative;
            overflow: hidden;
        }
        #waveform canvas {
            width: 100%;
            height: 100%;
        }
        #userPhoto {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-top: 10px;
            border: 2px solid #007bff;
        }
    </style>
</head>
<body>
    <h1>تسجيل الطلاقة - الفوج 4</h1>
    <img id="userPhoto" src="" alt="صورة المستخدم" style="display: none;"> <!-- Initially hidden -->
    <select id="userList">
        <option value="" disabled selected>اختر اسمك</option>
    </select>
    <button id="recordButton" disabled>بدء التسجيل</button>
    <div id="timer">00:00</div>
    <div id="waveform"><canvas id="waveformCanvas"></canvas></div>
    <div id="status">اختر اسمك واضغط على "بدء التسجيل"</div>
    <audio id="audioPlayback" controls style="margin-top: 20px;"></audio>

    <script>
        const users = [
            { name: "1_G4_بقال بسمة", photo: "G4_1.jpg" },
            { name: "2_G4_الوهلولي زياد", photo: "G4_2.jpg" },
            { name: "3_G4_بوسدرة محمود", photo: "G4_3.jpg" },
            { name: "4_G4_بوسكوري يوسف", photo: "G4_4.jpg" },
            { name: "5_G4_سي بل سناء", photo: "G4_5.jpg" },
            { name: "6_G4_رحمة مريم", photo: "G4_6.jpg" },
            { name: "7_G4_الشجعي اسية", photo: "G4_7.jpg" },
            { name: "8_G4_الوادي نادر", photo: "G4_8.jpg" },
            { name: "9_G4_دليزة محمد أمين", photo: "G4_9.jpg" },
            { name: "10_G4_وشن نور", photo: "G4_10.jpg" },
            { name: "11_G4_المين مريم", photo: "G4_11.jpg" },
            { name: "12_G4_بوكار ماريا", photo: "G4_12.jpg" },
            { name: "13_G4_كجضاض زينب", photo: "G4_13.jpg" },
            { name: "14_G4_شعرة محمد", photo: "G4_14.jpg" },
            { name: "15_G4_امزيل سليمان", photo: "G4_15.jpg" },
            { name: "16_G4_فاهم شيماء", photo: "G4_16.jpg" },
            { name: "17_G4_بوعربي سارة", photo: "G4_17.jpg" },
            { name: "18_G4_بيكاس عمران", photo: "G4_18.jpg" },
            { name: "19_G4_المنصوري أميرة", photo: "G4_19.jpg" },
            { name: "20_G4_الهمادي أيمن", photo: "G4_20.jpg" },
            { name: "21_G4_الداودي رضا", photo: "G4_21.jpg" },
            { name: "22_G4_القريسة خديجة", photo: "G4_22.jpg" },
            { name: "23_G4_اعراب  سارة", photo: "G4_23.jpg" },
            { name: "24_G4_زويهر ريان", photo: "G4_24.jpg" },
            { name: "25_G4_ايت القاضي ملاك", photo: "G4_25.jpg" },
            { name: "26_G4_ايت علي فردوس", photo: "G4_26.jpg" },
            { name: "27_G4_الدرهم يوسف", photo: "G4_27.jpg" },
            { name: "28_G4_الحرطاني أسماء", photo: "G4_28.jpg" },
            { name: "29_G4_دوقي بلال", photo: "G4_29.jpg" },
            { name: "30_G4_بهتيت ملا ك", photo: "G4_30.jpg" },
            { name: "31_G4_بوعربي علية", photo: "G4_31.jpg" },
            { name: "32_G4_الكرومي اخلاص", photo: "G4_32.jpg" },
            { name: "33_G4_بوسكري أحلام", photo: "G4_33.jpg" }
        ];

        let mediaRecorder;
        let audioChunks = [];
        let selectedUser = "";
        let timerInterval;
        let audioContext, analyser, dataArray, bufferLength;
        let isRecording = false;
        let startTime;

        // Populate the dropdown list with users
        const userList = document.getElementById('userList');
        users.forEach((user, index) => {
            const option = document.createElement('option');
            option.value = user.name;
            option.textContent = user.name;
            option.dataset.photo = user.photo; // Store the photo filename in the option
            userList.appendChild(option);
        });

        // Enable the "Start Recording" button and show the user's photo when a user is selected
        userList.addEventListener('change', (event) => {
            selectedUser = event.target.value;
            const selectedOption = event.target.options[event.target.selectedIndex];
            const userPhoto = selectedOption.dataset.photo;

            // Display the user's photo
            const userPhotoElement = document.getElementById('userPhoto');
            userPhotoElement.src = userPhoto;
            userPhotoElement.style.display = "block"; // Show the photo

            document.getElementById('recordButton').disabled = false;
        });

        // Start or stop recording when the button is clicked
        const recordButton = document.getElementById('recordButton');
        recordButton.addEventListener('click', async () => {
            if (recordButton.textContent === "بدء التسجيل") {
                await startRecording();
            } else {
                stopRecording();
            }
        });

        // Start recording
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);

                // Set up audio context and analyser for sound wave visualization
                audioContext = new AudioContext();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 2048; // Increase FFT size for smoother waveform
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);

                    // Set the audio playback source
                    const audio = document.getElementById('audioPlayback');
                    audio.src = audioUrl;

                    // Save the recording with the user's name
                    const link = document.createElement('a');
                    link.href = audioUrl;
                    link.download = `${selectedUser}.wav`;
                    link.click();

                    // Reset for the next recording
                    audioChunks = [];
                    document.getElementById('status').textContent = `تم إيقاف التسجيل. تم حفظ الملف باسم ${selectedUser}.wav`;
                    recordButton.textContent = "بدء التسجيل";
                    recordButton.disabled = true;
                    userList.value = "";
                    clearInterval(timerInterval);
                    document.getElementById('timer').textContent = "00:00";
                    isRecording = false;
                    stopSoundWave();
                };

                // Start recording
                mediaRecorder.start();
                document.getElementById('status').textContent = "جارٍ التسجيل...";
                recordButton.textContent = "إيقاف التسجيل";
                isRecording = true;

                // Start the timer
                startTime = Date.now();
                timerInterval = setInterval(updateTimer, 1000);

                // Start sound wave visualization
                drawSoundWave();
            } catch (error) {
                console.error("Error starting recording:", error);
                document.getElementById('status').textContent = "خطأ: تعذر الوصول إلى الميكروفون. يرجى التحقق من الأذونات.";
            }
        }

        // Stop recording
        function stopRecording() {
            mediaRecorder.stop();
            clearInterval(timerInterval);
            document.getElementById('timer').textContent = "00:00";
        }

        // Update the timer
        function updateTimer() {
            const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('timer').textContent = `00:${elapsedTime.toString().padStart(2, '0')}`;

            // Stop recording after 60 seconds
            if (elapsedTime >= 60) {
                clearInterval(timerInterval);
                mediaRecorder.stop();
                alert("انتهت الدقيقة! تم إيقاف التسجيل."); // Pop-up notification
            }
        }

        // Draw sound wave visualization
        function drawSoundWave() {
            const canvas = document.getElementById('waveformCanvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            function draw() {
                if (!isRecording) return; // Stop drawing if recording is stopped

                requestAnimationFrame(draw);
                analyser.getByteTimeDomainData(dataArray);

                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, width, height);

                ctx.lineWidth = 2;
                ctx.strokeStyle = '#007bff';
                ctx.beginPath();

                const sliceWidth = width / bufferLength;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = (v * height) / 2;

                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }

                    x += sliceWidth;
                }

                ctx.lineTo(width, height / 2);
                ctx.stroke();
            }
            draw();
        }

        // Stop sound wave visualization
        function stopSoundWave() {
            const canvas = document.getElementById('waveformCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    </script>
</body>
</html>
