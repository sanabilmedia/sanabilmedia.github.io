<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل الطلاقة</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Styles */
        body {
            font-family: 'Cairo', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Use min-height for better responsiveness */
            flex-direction: column;
            background-color: #121212; /* Deeper dark background */
            color: #e0e0e0; /* Softer text color */
            margin: 0; /* Reset margin for full height */
            padding: 20px; /* Add some padding for smaller screens */
            box-sizing: border-box; /* Include padding in width/height */
        }

        h1 {
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); /* Add a subtle shadow */
            margin-bottom: 20px;
        }

        /* Select Element Styling */
        select {
            padding: 12px 24px;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
            background-color: #212121;
            color: #eee;
            border: none;
            border-radius: 8px; /* Rounded corners */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); /* Subtle shadow */
            transition: all 0.2s ease-in-out; /* Smooth transition */
            outline: none; /* Remove outline */
        }

        select:hover {
            background-color: #333;
            transform: translateY(-2px); /* Slight lift on hover */
        }

        select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Button Styling */
        button {
            padding: 14px 28px;
            font-size: 18px;
            margin: 10px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            outline: none;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4); /* Shadow on text */
        }

        button:active {
            transform: translateY(1px); /* Push down slightly on click */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }


        #recordButton {
            background-color: #555;
            color: #fff;
        }

        #recordButton.recording {
            background-color: #e74c3c; /* Red when recording */
            color: #fff;
        }

        #recordButton.ready {
            background-color: #2ecc71; /* Green when ready */
            color: #fff;
        }

        /* Status and Timer */
        #status {
            margin-top: 20px;
            font-size: 18px;
            color: #9e9e9e;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        #timer {
            font-size: 28px;
            font-weight: bold;
            margin: 15px;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* Waveform */
        #waveform {
            width: 350px;
            height: 120px;
            border: none;
            border-radius: 10px;
            margin: 25px;
            position: relative;
            overflow: hidden;
            background: linear-gradient(to bottom, #2c3e50, #34495e); /* Gradient background */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        #waveform canvas {
            width: 100%;
            height: 100%;
        }

        /* User Photo */
        #userPhoto {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin-top: 15px;
            border: 3px solid #3498db;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        /* Audio Playback */
        audio {
            margin-top: 25px;
            width: 100%;
            max-width: 400px; /* Limit audio player width */
        }

        /* Password Overlay Styles */
        #passwordOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Dark semi-transparent overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top */
        }

        #passwordForm {
            background-color: #212121;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        #passwordInput {
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background-color: #333;
            color: #eee;
            margin-bottom: 10px;
        }

        #passwordSubmit {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background-color: #3498db;
            color: #fff;
            cursor: pointer;
        }

        /* Media Queries for responsiveness */
        @media (max-width: 600px) {
            h1 {
                font-size: 24px;
            }

            select, button {
                padding: 10px 18px;
                font-size: 14px;
            }

            #waveform {
                width: 90%;
                max-width: 300px;
            }
        }

    </style>
</head>
<body>

    <div id="passwordOverlay">
        <div id="passwordForm">
            <h2>ادخل كلمة المرور</h2>
            <input type="password" id="passwordInput" placeholder="كلمة المرور">
            <button id="passwordSubmit">دخول</button>
            <div id="passwordStatus" style="color: red; margin-top: 10px; display: none;">كلمة مرور خاطئة</div>
        </div>
    </div>

    <h1>تسجيل الطلاقة - الفوج 4</h1>
    <img id="userPhoto" src="" alt="صورة المستخدم" style="display: none;">
    <select id="userList">
        <option value="" disabled selected>اختر اسمك</option>
    </select>
    <button id="recordButton" disabled>بدء التسجيل</button>
    <div id="timer">00:00</div>
    <div id="waveform"><canvas id="waveformCanvas"></canvas></div>
    <div id="status">اختر اسمك واضغط على "بدء التسجيل"</div>
    <audio id="audioPlayback" controls></audio>

    <!-- Audio element for the notification sound -->
    <audio id="notificationSound" src="notification.mp3" preload="auto"></audio>

    <script>
        const password = "1978"; // **IMPORTANT: Change this!**
        let passwordEntered = false;

        const passwordOverlay = document.getElementById('passwordOverlay');
        const passwordInput = document.getElementById('passwordInput');
        const passwordSubmit = document.getElementById('passwordSubmit');
        const passwordStatus = document.getElementById('passwordStatus');

        passwordSubmit.addEventListener('click', () => {
            if (passwordInput.value === password) {
                passwordOverlay.style.display = 'none';
                passwordEntered = true;
                initializeApp(); // Call the rest of your script after successful password entry
            } else {
                passwordStatus.style.display = 'block'; // Show error message
            }
        });

        function initializeApp() {
            // Your existing JavaScript code here...

           const users = [
            { name: "1_G4_بقال بسمة", photo: "G4_1.jpg" },
            { name: "2_G4_الوهلولي زياد", photo: "G4_2.jpg" },
            { name: "3_G4_بوسدرة محمود", photo: "G4_3.jpg" },
            { name: "4_G4_بوسكوري يوسف", photo: "G4_4.jpg" },
            { name: "5_G4_سي بل سناء", photo: "G4_5.jpg" },
            { name: "6_G4_رحمة مريم", photo: "G4_6.jpg" },
            { name: "7_G4_الشجعي اسية", photo: "G4_7.jpg" },
            { name: "8_G4_الوادي نادر", photo: "G4_8.jpg" },
            { name: "9_G4_دليزة محمد أمين", photo: "G4_9.jpg" },
            { name: "10_G4_وشن نور", photo: "G4_10.jpg" },
            { name: "11_G4_المين مريم", photo: "G4_11.jpg" },
            { name: "12_G4_بوكار ماريا", photo: "G4_12.jpg" },
            { name: "13_G4_كجضاض زينب", photo: "G4_13.jpg" },
            { name: "14_G4_شعرة محمد", photo: "G4_14.jpg" },
            { name: "15_G4_امزيل سليمان", photo: "G4_15.jpg" },
            { name: "16_G4_فاهم شيماء", photo: "G4_16.jpg" },
            { name: "17_G4_بوعربي سارة", photo: "G4_17.jpg" },
            { name: "18_G4_بيكاس عمران", photo: "G4_18.jpg" },
            { name: "19_G4_المنصوري أميرة", photo: "G4_19.jpg" },
            { name: "20_G4_الهمادي أيمن", photo: "G4_20.jpg" },
            { name: "21_G4_الداودي رضا", photo: "G4_21.jpg" },
            { name: "22_G4_القريسة خديجة", photo: "G4_22.jpg" },
            { name: "23_G4_اعراب  سارة", photo: "G4_23.jpg" },
            { name: "24_G4_زويهر ريان", photo: "G4_24.jpg" },
            { name: "25_G4_ايت القاضي ملاك", photo: "G4_25.jpg" },
            { name: "26_G4_ايت علي فردوس", photo: "G4_26.jpg" },
            { name: "27_G4_الدرهم يوسف", photo: "G4_27.jpg" },
            { name: "28_G4_الحرطاني أسماء", photo: "G4_28.jpg" },
            { name: "29_G4_دوقي بلال", photo: "G4_29.jpg" },
            { name: "30_G4_بهتيت ملا ك", photo: "G4_30.jpg" },
            { name: "31_G4_بوعربي علية", photo: "G4_31.jpg" },
            { name: "32_G4_الكرومي اخلاص", photo: "G4_32.jpg" },
            { name: "33_G4_بوسكري أحلام", photo: "G4_33.jpg" }
        ];


            let mediaRecorder;
            let audioChunks = [];
            let selectedUser = "";
            let timerInterval;
            let audioContext, analyser, dataArray, bufferLength;
            let isRecording = false;
            let startTime;

            // Populate the dropdown list with users
            const userList = document.getElementById('userList');
            users.forEach((user, index) => {
                const option = document.createElement('option');
                option.value = user.name;
                option.textContent = user.name;
                option.dataset.photo = user.photo; // Store the photo filename in the option
                userList.appendChild(option);
            });

            // Enable the "Start Recording" button and show the user's photo when a user is selected
            userList.addEventListener('change', (event) => {
                selectedUser = event.target.value;
                const selectedOption = event.target.options[event.target.selectedIndex];
                const userPhoto = selectedOption.dataset.photo;

                // Display the user's photo
                const userPhotoElement = document.getElementById('userPhoto');
                userPhotoElement.src = userPhoto;
                userPhotoElement.style.display = "block"; // Show the photo

                document.getElementById('recordButton').disabled = false;
                document.getElementById('recordButton').classList.add('ready'); //set green color
                document.getElementById('recordButton').classList.remove('recording');
            });

            // Start or stop recording when the button is clicked
            const recordButton = document.getElementById('recordButton');
            recordButton.addEventListener('click', async () => {
                if (recordButton.textContent === "بدء التسجيل") {
                    await startRecording();
                } else {
                    stopRecording();
                }
            });

            // Start recording
            async function startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);

                    // Set up audio context and analyser for sound wave visualization
                    audioContext = new AudioContext();
                    analyser = audioContext.createAnalyser();
                    const source = audioContext.createMediaStreamSource(stream);
                    source.connect(analyser);
                    analyser.fftSize = 2048; // Increase FFT size for smoother waveform
                    bufferLength = analyser.frequencyBinCount;
                    dataArray = new Uint8Array(bufferLength);

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);

                        // Set the audio playback source
                        const audio = document.getElementById('audioPlayback');
                        audio.src = audioUrl;

                        // Save the recording with the user's name
                        const link = document.createElement('a');
                        link.href = audioUrl;
                        link.download = `${selectedUser}.wav`;
                        link.click();

                        // Reset for the next recording
                        audioChunks = [];
                        document.getElementById('status').textContent = `تم إيقاف التسجيل. تم حفظ الملف باسم ${selectedUser}.wav`;
                        recordButton.textContent = "بدء التسجيل";
                        recordButton.disabled = true;
                        document.getElementById('userList').disabled = false; // Enable the user list after recording
                        userList.value = "";
                        clearInterval(timerInterval);
                        document.getElementById('timer').textContent = "00:00";
                        isRecording = false;
                        stopSoundWave();

                        document.getElementById('recordButton').classList.remove('recording'); //set grey color after recording
                        document.getElementById('recordButton').classList.remove('ready');

                    };

                    // Start recording
                    mediaRecorder.start();
                    document.getElementById('status').textContent = "جارٍ التسجيل...";
                    recordButton.textContent = "إيقاف التسجيل";
                    document.getElementById('recordButton').classList.remove('ready');
                    document.getElementById('recordButton').classList.add('recording'); //set red color
                    isRecording = true;
                    document.getElementById('userList').disabled = true; // Disable the user list during recording


                    // Start the timer
                    startTime = Date.now();
                    timerInterval = setInterval(updateTimer, 1000);

                    // Start sound wave visualization
                    drawSoundWave();
                } catch (error) {
                    console.error("Error starting recording:", error);
                    document.getElementById('status').textContent = "خطأ: تعذر الوصول إلى الميكروفون. يرجى التحقق من الأذونات.";
                }
            }

            // Stop recording
            function stopRecording() {
                mediaRecorder.stop();
                clearInterval(timerInterval);
                document.getElementById('timer').textContent = "00:00";
            }

           // Update the timer
           function updateTimer() {
           const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
           const minutes = Math.floor(elapsedTime / 60);
           const seconds = elapsedTime % 60;
           document.getElementById('timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

           // Stop recording after 66 seconds
           if (elapsedTime >= 66) {
           clearInterval(timerInterval);
           mediaRecorder.stop();

           // Play the notification sound
           const notificationSound = document.getElementById('notificationSound');
           // Safari mobile fix : https://stackoverflow.com/questions/45693864/audio-play-is-not-allowed-in-safari-ios-11
           notificationSound.currentTime = 0;
           notificationSound.play().then(() => { // Play sound first
           setTimeout(() => {
           alert("انتهت الدقيقة! تم إيقاف التسجيل."); // Then show alert
           }, 100); // Small delay to ensure sound plays
           }).catch(error => {
           console.error("Autoplay was prevented:", error);
           alert("انتهت الدقيقة! تم إيقاف التسجيل. (Notification sound might be blocked by your browser.)"); // Show alert even if sound fails
           });
           }
           }

            // Draw sound wave visualization
            function drawSoundWave() {
                const canvas = document.getElementById('waveformCanvas');
                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;

                function draw() {
                    if (!isRecording) return; // Stop drawing if recording is stopped

                    requestAnimationFrame(draw);
                    analyser.getByteTimeDomainData(dataArray);

                    ctx.fillStyle = 'rgba(52, 73, 94, 0.8)'; // Slightly transparent background
                    ctx.fillRect(0, 0, width, height);

                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#81D4FA'; // Light Blue Color
                    ctx.beginPath();

                    const sliceWidth = width / bufferLength;
                    let x = 0;

                    for (let i = 0; i < bufferLength; i++) {
                        const v = dataArray[i] / 128.0;
                        const y = (v * height) / 2;

                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }

                        x += sliceWidth;
                    }

                    ctx.lineTo(width, height / 2);
                    ctx.stroke();
                }
                draw();
            }

            // Stop sound wave visualization
            function stopSoundWave() {
                const canvas = document.getElementById('waveformCanvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        //Prevent running code before the password
        if(!passwordEntered){
            passwordOverlay.style.display = 'flex';
        }
    </script>
</body>
</html>
